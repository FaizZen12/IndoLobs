<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace Peternakan Lobster</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #f5f7fa;
        }
        .marketplace-header {
            background: linear-gradient(120deg, #267a4a 0%, #1e3a3a 100%);
            color: #fff;
            padding: 2rem 1rem 1rem 1rem;
            text-align: center;
            border-radius: 0 0 24px 24px;
            margin-bottom: 2rem;
        }
        .search-filter-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0 0.5rem 0;
            flex-wrap: wrap;
        }
        .search-filter-bar input,
        .search-filter-bar select {
            padding: 0.7rem 1rem;
            border-radius: 8px;
            border: 1px solid #267a4a;
            font-size: 1rem;
            min-width: 160px;
        }
        .filter-advanced {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .filter-chip {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 0.3rem 0.8rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip:hover,
        .filter-chip.active {
            background: #f5b301;
            color: #1a3c2b;
        }
        .farmers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 2rem auto;
            max-width: 1200px;
            padding: 0 1rem;
        }
        .farmer-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(38,122,74,0.09);
            overflow: hidden;
            transition: box-shadow 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .farmer-card:hover {
            box-shadow: 0 6px 24px rgba(38,122,74,0.18);
            transform: translateY(-4px) scale(1.02);
        }
        .farmer-cover {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #e0f7fa;
        }
        .farmer-info {
            padding: 1.2rem 1rem 1rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .farmer-name {
            font-size: 1.15rem;
            font-weight: bold;
            color: #267a4a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .verified-badge {
            background: #f5b301;
            color: #fff;
            font-size: 0.8rem;
            border-radius: 6px;
            padding: 0.1rem 0.5rem;
            font-weight: bold;
        }
        .farmer-location {
            font-size: 0.98rem;
            color: #1e3a3a;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .farmer-rating {
            color: #f5b301;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .rating-number {
            color: #666;
            font-size: 0.9rem;
        }
        .camera-status {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .farmer-category {
            display: inline-block;
            background: #267a4a;
            color: #fff;
            font-size: 0.85rem;
            border-radius: 6px;
            padding: 0.2rem 0.7rem;
            margin-bottom: 0.5rem;
            margin-right: 0.5rem;
        }
        .farmer-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .lihat-toko-btn {
            background: #f5b301;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 0.7rem;
            transition: background 0.2s;
        }
        .lihat-toko-btn:hover {
            background: #267a4a;
        }
        .no-results {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }
        @media (max-width: 700px) {
            .farmers-grid {
                grid-template-columns: 1fr;
                gap: 1.2rem;
            }
            .marketplace-header {
                padding: 1.2rem 0.5rem 0.7rem 0.5rem;
            }
            .search-filter-bar {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <nav class="main-navbar">
        <div class="nav-logo">ü¶û IndoLobs</div>
        <div class="nav-links">
            <a href="index.html">Beranda</a>
            <a href="marketplace.html" class="active">Marketplace</a>
            <a href="forum.html">Komunitas</a>
            <a href="news.html">Edukasi</a>
            <a href="keranjang.html" class="cart-icon">
                üõí Keranjang
                <span class="cart-badge" id="cartCount">0</span>
            </a>
            <a href="dashboard.html">Dashboard</a>
        </div>
        <div class="nav-user" id="nav-user"></div>
    </nav>
    
    <header class="marketplace-header">
        <h1>Marketplace Peternakan Lobster</h1>
        <p>Temukan peternak lobster terpercaya dengan live kamera dan kualitas ekspor</p>
        
        <div class="search-filter-bar">
            <input type="text" id="search" placeholder="Cari peternak atau lokasi...">
            <select id="filter-location">
                <option value="">Semua Lokasi</option>
                <option value="Jawa Barat">Jawa Barat</option>
                <option value="Jawa Tengah">Jawa Tengah</option>
                <option value="Jawa Timur">Jawa Timur</option>
                <option value="Sumatera Utara">Sumatera Utara</option>
                <option value="Sumatera Selatan">Sumatera Selatan</option>
                <option value="Sulawesi Selatan">Sulawesi Selatan</option>
                <option value="Kalimantan Barat">Kalimantan Barat</option>
            </select>
            <select id="filter-category">
                <option value="">Semua Jenis Lobster</option>
                <option value="Air Tawar">Lobster Air Tawar</option>
                <option value="Air Laut">Lobster Air Laut</option>
                <option value="Mutiara">Lobster Mutiara</option>
                <option value="Batu">Lobster Batu</option>
            </select>
            <select id="filter-price">
                <option value="">Semua Harga</option>
                <option value="0-500000">Dibawah Rp 500.000</option>
                <option value="500000-1000000">Rp 500.000 - 1.000.000</option>
                <option value="1000000-2000000">Rp 1.000.000 - 2.000.000</option>
                <option value="2000000+">Diatas Rp 2.000.000</option>
            </select>
            <select id="filter-rating">
                <option value="">Semua Rating</option>
                <option value="4.5">4.5+ Bintang</option>
                <option value="4.0">4.0+ Bintang</option>
                <option value="3.5">3.5+ Bintang</option>
            </select>
        </div>
        
        <div class="filter-advanced">
            <div class="filter-chip" data-filter="camera">üü¢ Live Kamera</div>
            <div class="filter-chip" data-filter="verified">‚úÖ Terverifikasi</div>
            <div class="filter-chip" data-filter="export">üåê Ekspor Legal</div>
            <div class="filter-chip" data-filter="organic">üå± Organik</div>
        </div>
    </header>
    
    <section class="farmers-grid" id="farmers-grid">
        <!-- Kartu toko diisi JS -->
    </section>
    
    <footer class="footer">
        <div>Lobster Marketplace &copy; 2025 | Made in Indonesia</div>
    </footer>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        const navUser = document.getElementById('nav-user');
        if (user) {
            navUser.innerHTML = `<span>üëã Hai, ${user.name}</span>
                <button id="logoutBtn" class="logout-btn">Logout</button>`;
            document.getElementById("logoutBtn").addEventListener("click", function() {
                localStorage.removeItem("currentUser");
                window.location.href = "login.html";
            });
        } else {
            navUser.innerHTML = `<a href="login.html" class="login-btn">Login</a>`;
        }
        
        updateCartCount();
        loadFarmers();
        setupEventListeners();
    });

    function loadFarmers() {
        const users = JSON.parse(localStorage.getItem('users')) || [];
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        
        // Get only farmers
        const farmers = users.filter(user => user.type === 'farmer');
        
        // Enhance farmer data with products and stats
        const enhancedFarmers = farmers.map(farmer => {
            const farmerProducts = products.filter(p => p.farmerId === farmer.email);
            const farmerOrders = orders.filter(o => o.farmerId === farmer.email);
            
            // Calculate stats
            const totalSales = farmerOrders.length;
            const totalRevenue = farmerOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const avgRating = farmerProducts.length > 0 ? 
                farmerProducts.reduce((sum, p) => sum + p.rating, 0) / farmerProducts.length : 0;
            
            return {
                ...farmer,
                products: farmerProducts,
                totalSales: totalSales,
                totalRevenue: totalRevenue,
                avgRating: avgRating,
                hasLiveCamera: farmer.camera === 'available',
                isVerified: true, // All demo farmers are verified
                hasExport: true,
                isOrganic: true
            };
        });
        
        renderFarmers(enhancedFarmers);
    }

    function renderFarmers(farmers) {
        const farmersContainer = document.getElementById('farmers-grid');
        
        if (farmers.length === 0) {
            farmersContainer.innerHTML = `
                <div class="no-results">
                    <h3>üòî Tidak ada peternak ditemukan</h3>
                    <p>Coba ubah filter pencarian Anda</p>
                </div>
            `;
            return;
        }
        
        farmersContainer.innerHTML = farmers.map(farmer => `
            <div class="farmer-card" data-farmer-id="${farmer.email}">
                <div class="farmer-cover">
                    <img src="https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=800&q=80" alt="${farmer.business}">
                    ${farmer.isVerified ? '<span class="verified-badge">‚úÖ Terverifikasi</span>' : ''}
                </div>
                <div class="farmer-info">
                    <h3>${farmer.business}</h3>
                    <div class="farmer-location">
                        <span>üìç ${farmer.location}, Indonesia</span>
                    </div>
                    <div class="farmer-rating">
                        <span class="stars">${'‚≠ê'.repeat(Math.floor(farmer.avgRating))}${'‚òÜ'.repeat(5 - Math.floor(farmer.avgRating))}</span>
                        <span class="rating-number">(${farmer.avgRating.toFixed(1)})</span>
                    </div>
                    <div class="farmer-stats">
                        <span>üìä ${farmer.totalSales} Penjualan</span>
                        <span>üë• ${farmer.followers || 0} Pengikut</span>
                    </div>
                    <div class="camera-status">
                        ${farmer.hasLiveCamera ? 'üü¢ Live Kamera' : 'üî¥ Kamera Offline'}
                    </div>
                    <div class="farmer-category">
                        ${farmer.products.length} Produk Tersedia
                    </div>
                    <button class="view-shop-btn" onclick="viewShop('${farmer.email}')">
                        Lihat Toko
                    </button>
                </div>
            </div>
        `).join('');
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartCount = document.getElementById('cartCount');
        if (cartCount) {
            cartCount.textContent = totalItems;
            cartCount.style.display = totalItems > 0 ? 'flex' : 'none';
        }
    }

    function setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }

        // Filter functionality
        const filterInputs = document.querySelectorAll('.search-filter-bar select');
        filterInputs.forEach(input => {
            input.addEventListener('change', applyFilters);
        });

        // Advanced filter chips
        const filterChips = document.querySelectorAll('.filter-chip');
        filterChips.forEach(chip => {
            chip.addEventListener('click', function() {
                this.classList.toggle('active');
                applyFilters();
            });
        });
    }

    function applyFilters() {
        const searchTerm = document.getElementById('search')?.value.toLowerCase() || '';
        const locationFilter = document.getElementById('filter-location')?.value || '';
        const categoryFilter = document.getElementById('filter-category')?.value || '';
        const priceFilter = document.getElementById('filter-price')?.value || '';
        const ratingFilter = document.getElementById('filter-rating')?.value || '';
        
        // Get active filter chips
        const activeChips = Array.from(document.querySelectorAll('.filter-chip.active'))
            .map(chip => chip.textContent.trim());

        const users = JSON.parse(localStorage.getItem('users')) || [];
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const orders = JSON.parse(localStorage.getItem('orders')) || [];
        
        let farmers = users.filter(user => user.type === 'farmer');
        
        // Apply search filter
        if (searchTerm) {
            farmers = farmers.filter(farmer => 
                farmer.business?.toLowerCase().includes(searchTerm) ||
                farmer.location?.toLowerCase().includes(searchTerm)
            );
        }

        // Apply location filter
        if (locationFilter && locationFilter !== 'Semua Lokasi') {
            farmers = farmers.filter(farmer => farmer.location === locationFilter);
        }

        // Apply category filter
        if (categoryFilter && categoryFilter !== 'Semua Jenis Lobster') {
            const farmerProducts = products.filter(p => 
                farmers.some(f => f.email === p.farmerId) && 
                p.type === categoryFilter
            );
            const farmerIds = [...new Set(farmerProducts.map(p => p.farmerId))];
            farmers = farmers.filter(farmer => farmerIds.includes(farmer.email));
        }

        // Apply price filter
        if (priceFilter && priceFilter !== 'Semua Harga') {
            const [minPrice, maxPrice] = priceFilter.split('-').map(p => parseInt(p));
            const farmerProducts = products.filter(p => 
                farmers.some(f => f.email === p.farmerId) && 
                p.price >= minPrice && p.price <= maxPrice
            );
            const farmerIds = [...new Set(farmerProducts.map(p => p.farmerId))];
            farmers = farmers.filter(farmer => farmerIds.includes(farmer.email));
        }

        // Apply rating filter
        if (ratingFilter && ratingFilter !== 'Semua Rating') {
            const minRating = parseFloat(ratingFilter);
            const farmerProducts = products.filter(p => 
                farmers.some(f => f.email === p.farmerId) && 
                p.rating >= minRating
            );
            const farmerIds = [...new Set(farmerProducts.map(p => p.farmerId))];
            farmers = farmers.filter(farmer => farmerIds.includes(farmer.email));
        }

        // Apply advanced filter chips
        if (activeChips.includes('üü¢ Live Kamera')) {
            farmers = farmers.filter(farmer => farmer.hasLiveCamera);
        }
        if (activeChips.includes('‚úÖ Terverifikasi')) {
            farmers = farmers.filter(farmer => farmer.isVerified);
        }
        if (activeChips.includes('üåê Ekspor Legal')) {
            farmers = farmers.filter(farmer => farmer.hasExport);
        }
        if (activeChips.includes('üå± Organik')) {
            farmers = farmers.filter(farmer => farmer.isOrganic);
        }

        // Enhance farmer data with products and stats
        const enhancedFarmers = farmers.map(farmer => {
            const farmerProducts = products.filter(p => p.farmerId === farmer.email);
            const farmerOrders = orders.filter(o => o.farmerId === farmer.email);
            
            const totalSales = farmerOrders.length;
            const totalRevenue = farmerOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const avgRating = farmerProducts.length > 0 ? 
                farmerProducts.reduce((sum, p) => sum + p.rating, 0) / farmerProducts.length : 0;
            
            return {
                ...farmer,
                products: farmerProducts,
                totalSales: totalSales,
                totalRevenue: totalRevenue,
                avgRating: avgRating,
                hasLiveCamera: farmer.hasLiveCamera,
                isVerified: farmer.isVerified,
                hasExport: farmer.hasExport,
                isOrganic: farmer.isOrganic
            };
        });

        renderFarmers(enhancedFarmers);
    }

    function viewShop(farmerId) {
        window.location.href = `detail-toko.html?farmer=${farmerId}`;
    }

    function clearFilters() {
        // Reset all filter inputs
        const searchInput = document.getElementById('search');
        if (searchInput) searchInput.value = '';
        
        const filterSelects = document.querySelectorAll('.search-filter-bar select');
        filterSelects.forEach(select => {
            select.value = '';
        });
        
        // Remove active chips
        const activeChips = document.querySelectorAll('.filter-chip.active');
        activeChips.forEach(chip => chip.classList.remove('active'));
        
        // Reload all farmers
        loadFarmers();
    }
</script>
</body>
</html>